<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>CineGuard — Advanced Seat Booking</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{
  --bg:#fbfcfe; --card:#fff; --muted:#666;
  --premium:#ffb300; --normal:#4caf50; --economy:#90a4ae;
}
body{font-family:Inter,Arial,Helvetica,sans-serif; margin:18px; background:var(--bg); color:#111}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px}
.controls{display:flex;gap:8px;align-items:center}
.card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 4px 18px rgba(20,20,40,0.06)}
h1{margin:0 0 8px 0;font-size:20px}
.screen-label{background:#222;color:#fff;padding:8px;border-radius:6px;text-align:center;margin-bottom:12px}
.stage{display:flex;flex-direction:column;align-items:center}
.legend{display:flex;gap:8px;margin:8px 0}
.legend span{display:flex;gap:6px;align-items:center;padding:6px;border-radius:6px;font-size:13px}
.legend .box{width:16px;height:12px;border-radius:3px;display:inline-block}
.container{display:flex;gap:18px;margin-top:12px}
.left{flex:1}
.right{width:320px}

.seat-map{background:linear-gradient(180deg,#fff,#fbfbff);padding:12px;border-radius:10px;display:flex;flex-direction:column;align-items:center}
.row{display:flex;gap:8px;margin:6px 0;justify-content:center;transition:transform .18s}
.row .aisle{width:24px}
.seat{
  width:44px;height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;
  background:#e9eef1;color:#04323a;font-weight:600;cursor:pointer;box-shadow:0 2px 6px rgba(12,35,55,0.04);
  transition:transform .12s, box-shadow .12s;
}
.seat:hover{transform:translateY(-6px);box-shadow:0 10px 20px rgba(10,30,60,0.12)}
.seat.taken{background:#b71c1c;color:#fff;cursor:not-allowed;opacity:0.88;transform:none}
.seat.premium{background:var(--premium);color:#2b2b2b}
.seat.normal{background:var(--normal);color:#fff}
.seat.economy{background:var(--economy);color:#fff}

.screen-actions{display:flex;gap:8px;margin-bottom:8px}
.select{padding:8px;border-radius:6px;border:1px solid #ddd;background:#fff}

.info-panel{position:sticky;top:18px;padding:12px;border-radius:10px}
.info-panel h3{margin:0 0 8px 0}
.form-row{margin:8px 0}
input[type=text], input[type=tel]{width:100%;padding:8px;border-radius:6px;border:1px solid #ddd}
button{padding:10px 12px;border-radius:8px;border:none;background:#1976d2;color:white;cursor:pointer}
.small{font-size:13px;color:var(--muted)}

#popup{position:fixed;z-index:60;pointer-events:none;}
#popup .bubble{pointer-events:auto;background:#fff;padding:8px;border-radius:8px;box-shadow:0 8px 20px rgba(20,30,60,0.12)}

.seat.searchMatch{
  outline: 4px solid #ff4081;
  transform: scale(1.18);
}
</style>

</head>
<body>
  <div class="header">
    <div>
      <h1>CineGuard — Advanced Seat Mapping (All Options)</h1>
      <div class="small">Choose screen layout, seat types, hover for info, and book seats.</div>
    </div>
    <div class="controls card">
      <label>Select Screen</label>
      <select id="screenSelect" class="select">
        <option value="big">Screen 1 — Big Hall (curved rows)</option>
        <option value="small">Screen 2 — Small Hall (balanced)</option>
        <option value="vip">Screen 3 — VIP (recliners)</option>
        <option value="pvr">Screen 4 — PVR-style (sections)</option>
      </select>
    </div>
  </div>

  
    <div class="card" style="margin-top:12px;padding:12px;">
      <label><strong>Search Seat:</strong></label>
      <input id="searchSeat" type="text" placeholder="Enter seat ID (e.g., A5, B3-L, C2-C)" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;margin-top:6px">
      <div id="searchMsg" style="margin-top:6px;font-size:13px;color:#444;"></div>
    </div>

  <div class="container">
    <div class="left card">
      <div class="screen-label">SCREEN</div>

      <div class="legend">
        <span><i class="box" style="background:var(--premium)"></i> Premium</span>
        <span><i class="box" style="background:var(--normal)"></i> Normal</span>
        <span><i class="box" style="background:var(--economy)"></i> Economy</span>
        <span class="small">Taken seats are red</span>
      </div>

      <div id="seatMap" class="seat-map" aria-label="seat-map"></div>
    </div>

    <aside class="right">
      <div style="margin-bottom:12px;"><label>Search Seat <input id="searchInput" type="text" placeholder="e.g. A5 or B4-C"></label></div>
<div class="info-panel card">
        <h3>Booking</h3>
        <div class="form-row">
          <label>Seat <input id="seatInput" type="text" readonly></label>
        </div>
        <div class="form-row">
          <label>Type <input id="typeInput" type="text" readonly></label>
        </div>
        <div class="form-row">
          <label>Price <input id="priceInput" type="text" readonly></label>
        </div>
        <div class="form-row">
          <label>Name <input id="nameInput" type="text" placeholder="Full name"></label>
        </div>
        <div class="form-row">
          <label>Phone <input id="phoneInput" type="tel" placeholder="+91xxxxxxxxxx"></label>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="bookBtn">Book Seat</button>
          <button id="clearBtn" style="background:#aaa">Clear</button>
        </div>
        <div id="msg" class="small" style="margin-top:8px"></div>
      </div>
    </aside>
  </div>

  <div id="popup"></div>

<script>
// Seat layouts for different screens (rows, seat counts, aisles, mapping, types)
const layouts = {
  big: {
    rows: ['A','B','C','D','E','F','G','H','I'],
    rowSeats: [10,12,14,16,16,14,12,10,8], // curved (center larger)
    aisles: [3, -1], // place an aisle after 3 seats then centered
    center:true,
    baseTypes: function(rowIndex, seatIndex, total){
      // premium center rows, economy back/front
      if(rowIndex<=2) return 'premium';
      if(rowIndex>=6) return 'economy';
      return 'normal';
    }
  },
  small: {
    rows: ['A','B','C','D','E','F'],
    rowSeats: [8,8,10,10,10,8],
    aisles: [5],
    center:false,
    baseTypes: function(rowIndex, seatIndex){
      if(rowIndex<=1) return 'premium';
      if(rowIndex>=4) return 'economy';
      return 'normal';
    }
  },
  vip: {
    rows: ['A','B','C','D'],
    rowSeats: [6,6,6,6],
    aisles: [],
    center:false,
    baseTypes: ()=>'premium'
  },
  pvr: {
    // left, center, right sections
    sections: [
      {name:'Left', rows:['A','B','C','D','E'], seats: [4,5,5,5,4], offset:-1},
      {name:'Center', rows:['A','B','C','D','E'], seats: [6,8,8,8,6], offset:0},
      {name:'Right', rows:['A','B','C','D','E'], seats: [4,5,5,5,4], offset:1}
    ],
    sectioned:true,
    baseTypes: function(rIdx,sIdx,sectIdx){
      // center section mostly normal, edges economy
      if(sectIdx===1) return 'normal';
      if(rIdx<=1) return 'premium';
      return 'economy';
    }
  }
};

// Pricing per type
const pricing = {premium:350, normal:200, economy:120};

// Utility to fetch taken seats from server
async function fetchTaken(){
  try{
    const res = await fetch('fetch_bookings.php');
    const data = await res.json();
    return new Set(data.map(x=>x.seat));
  }catch(e){
    console.warn('fetch failed', e);
    return new Set();
  }
}

let currentLayout='big';
let selected=null;
let seatMeta = {}; // seatId -> {type,price,coords}

const seatMapEl = document.getElementById('seatMap');
const popup = document.getElementById('popup');

async function renderLayout(key){
  seatMapEl.innerHTML='';
  seatMeta = {};
  currentLayout = key;
  const taken = await fetchTaken();

  if(layouts[key].sectioned){
    // PVR style: three sections side-by-side
    const wrap = document.createElement('div');
    wrap.style.display='flex';
    wrap.style.gap='18px';
    layouts[key].sections.forEach((sec, sIdx)=>{
      const col = document.createElement('div');
      col.style.display='flex'; col.style.flexDirection='column'; col.style.alignItems='center';
      const title = document.createElement('div'); title.textContent = sec.name; title.style.marginBottom='6px';
      col.appendChild(title);
      sec.rows.forEach((r, ri)=>{
        const rowEl = document.createElement('div'); rowEl.className='row';
        const seatsCount = sec.seats[ri];
        for(let c=1;c<=seatsCount;c++){
          const seatId = r + (sIdx*100 + c); // unique numeric suffix per section to avoid collisions like A1 multiple
          const display = `${r}${c}${sIdx===0?'-L':sIdx===2?'-R':'-C'}`;
          const type = layouts[key].baseTypes(ri, c, sIdx);
          const price = pricing[type];
          const seat = document.createElement('div');
          seat.className='seat ' + type;
          seat.textContent = display;
          seat.dataset.seat = display;
          if(taken.has(display)) seat.classList.add('taken');

          seat.addEventListener('mouseenter', (ev)=> showPopup(ev, display, type, price));
          seat.addEventListener('mouseleave', hidePopup);
          seat.addEventListener('click', ()=>selectSeat(display, type, price, seat));

          rowEl.appendChild(seat);
          seatMeta[display] = {type,price};
        }
        col.appendChild(rowEl);
      });
      wrap.appendChild(col);
    });
    seatMapEl.appendChild(wrap);
    return;
  }

  const layout = layouts[key];
  layout.rows.forEach((r, ri)=>{
    const count = layout.rowSeats[ri];
    const rowEl = document.createElement('div');
    rowEl.className='row';
    // center the row by adding spacer elements if center true
    const spacer = document.createElement('div'); spacer.style.width='18px';
    // build seats with potential aisle positions
    for(let i=1;i<=count;i++){
      const seatId = r + i;
      const type = layout.baseTypes(ri, i, count);
      const price = pricing[type];
      const seat = document.createElement('div');
      seat.className = 'seat ' + type;
      seat.textContent = seatId;
      seat.dataset.seat = seatId;
      if(taken.has(seatId)) seat.classList.add('taken');

      seat.addEventListener('mouseenter', (ev)=> showPopup(ev, seatId, type, price));
      seat.addEventListener('mouseleave', hidePopup);
      seat.addEventListener('click', ()=>selectSeat(seatId, type, price, seat));

      rowEl.appendChild(seat);
      // insert an aisle visually for some patterns
      if(layout.aisles && layout.aisles.includes(i)){
        const aisle = document.createElement('div'); aisle.className='aisle';
        rowEl.appendChild(aisle);
      }
      seatMeta[seatId] = {type, price};
    }
    seatMapEl.appendChild(rowEl);
  });
}

function showPopup(ev, seatId, type, price){
  popup.innerHTML = '<div class="bubble"><strong>'+seatId+'</strong><div>Type: '+type+'</div><div>Price: ₹'+price+'</div></div>';
  popup.style.left = (ev.pageX + 12) + 'px';
  popup.style.top = (ev.pageY + 12) + 'px';
}
function hidePopup(){ popup.innerHTML=''; }

function selectSeat(seatId, type, price, seatEl=null){
  if(seatEl && seatEl.classList.contains('taken')) return;
  selected = seatId;
  document.getElementById('seatInput').value = seatId;
  document.getElementById('typeInput').value = type;
  document.getElementById('priceInput').value = '₹' + price;
  // highlight UI-selected seat
  document.querySelectorAll('.seat').forEach(s=>s.classList.remove('selected'));
  if(seatEl) seatEl.classList.add('selected');
}

document.getElementById('screenSelect').addEventListener('change', (e)=>{
  renderLayout(e.target.value);
});

document.getElementById('clearBtn').addEventListener('click', ()=>{
  selected = null;
  document.getElementById('seatInput').value='';
  document.getElementById('typeInput').value='';
  document.getElementById('priceInput').value='';
  document.getElementById('nameInput').value='';
  document.getElementById('phoneInput').value='';
  document.querySelectorAll('.seat').forEach(s=>s.classList.remove('selected'));
  document.getElementById('msg').textContent = '';
});

document.getElementById('bookBtn').addEventListener('click', async ()=>{
  const seat = document.getElementById('seatInput').value;
  const type = document.getElementById('typeInput').value;
  const priceText = document.getElementById('priceInput').value;
  const price = priceText ? parseInt(priceText.replace(/[^0-9]/g,'')) : 0;
  const name = document.getElementById('nameInput').value.trim();
  const phone = document.getElementById('phoneInput').value.trim();
  if(!seat){ alert('Select a seat'); return; }
  if(!name||!phone){ alert('Enter name and phone'); return; }

  const data = new URLSearchParams({seat, type, price, name, phone});
  const res = await fetch('book_seat.php', {method:'POST', body: data});
  const txt = await res.text();
  document.getElementById('msg').textContent = txt;
  // re-render to show taken seats
  await renderLayout(currentLayout);
});

// initial render
renderLayout('big');

// Seat search functionality
document.getElementById('searchInput').addEventListener('input', function() {
  const val = this.value.trim().toUpperCase();
  document.querySelectorAll('.seat').forEach(seat => {
    const match = seat.textContent.toUpperCase().includes(val);
    seat.style.outline = match && val ? '2px solid #f44336' : '';
  });
});


// Seat Search Bar
document.getElementById('searchSeat').addEventListener('input', ()=>{
  const q = document.getElementById('searchSeat').value.trim().toUpperCase();
  const msg = document.getElementById('searchMsg');

  document.querySelectorAll('.seat').forEach(s => s.classList.remove('searchMatch'));

  if(!q){
    msg.textContent = '';
    return;
  }

  const match = Array.from(document.querySelectorAll('.seat'))
                      .find(s => s.dataset.seat.toUpperCase() === q);

  if(match){
    match.classList.add('searchMatch');
    msg.textContent = 'Seat found: ' + q;
    match.scrollIntoView({behavior:'smooth', block:'center'});
  } else {
    msg.textContent = 'Seat not found.';
  }
});

</script>
</body>
</html>
